<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto_Kid | Quản Lý Sản Phẩm</title>
    <link rel="shortcut icon" href="./img/svg/logo.svg" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/style.min.css" type="text/css">
    <style>
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }
        .table th, .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .users-table.table-wrapper {
            max-height: 450px; /* Đặt chiều cao tối đa cho khung chứa bảng */
            overflow-y: auto;  /* Bật cuộn dọc */
        }
        .posts-table {
            width: 100%; /* Đảm bảo bảng chiếm toàn bộ chiều rộng */
            border-collapse: collapse;
        }

        /* Thêm viền để dễ nhìn */
        .posts-table th, .posts-table td {
            border: 1px solid #ddd;
        }

        .cart-empty p {
            font-weight: bold;
            color: #888;
        }
        .modal-dialog {
            max-width: 80%; /* Đặt chiều rộng tối đa của modal là 80% của màn hình */
            width: auto; /* Đảm bảo modal có chiều rộng tự động theo nội dung */
        }

        .modal-content {
            overflow-x: auto; /* Cho phép cuộn ngang nếu cần */
        }

        .table {
            width: 100%; /* Đảm bảo bảng chiếm toàn bộ chiều rộng trong modal */
            table-layout: auto; /* Cho phép bảng tự động thay đổi kích thước */
        }

        .table th, .table td {
            white-space: normal; /* Cho phép nội dung tự động xuống dòng */
            word-wrap: break-word;
            word-break: break-word;
        }
        tr.selected {
            background-color: #f0f8ff; /* Màu nền sáng khi chọn */
            cursor: pointer;
        }

        /* Hiệu ứng hover khi di chuột qua dòng sản phẩm */
        tr:hover {
            background-color: #e0e0e0; /* Màu nền khi hover */
        }

    </style>
</head>
<body>
<div class="page-flex">
    <div th:insert="fragments/sidebar_admin :: sidebar"></div>
    <div class="main-wrapper">
        <div th:insert="fragments/header_admin :: header"></div>
        <main class="main users chart-page scrollable-content">
            <div style="padding: 7px">
                <h2 class="main-title" style="margin-bottom: -15px;">Bán Hàng</h2>
                <hr>
                <button class="btn btn-warning mb-3" onclick="createInvoice()">Tạo hóa đơn</button>
                <div class="invoice-list d-flex flex-wrap mb-3">
                    <div th:each="hoaDon : ${lhd}"
                         class="tab-item btn btn-outline-primary"
                         th:id="'invoice-' + ${hoaDon.id}"
                         th:text="${hoaDon.maHD}">
                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteInvoice(${hoaDon.id})">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <hr style="margin: 5px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Đơn hàng: <span id="selected-invoice"></span></h5>
                </div>
                <div class="row">
                    <div class="col-7">
                        <h5>Danh sách sản phẩm</h5>
                        <table id="sanPhamTable" class="posts-table">
                            <thead>
                            <tr class="users-table-info" style="color: black; font-size: 15px;">
                                <th>STT</th>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Giá bán</th>
                                <th>Thương hiệu</th>
                                <th>Chất liệu</th>
                                <th>Kích cỡ</th>
                                <th>Màu sắc</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="sp,stat : ${spcts}" th:if="${sp.trangThaiSPCT} == 'Còn hàng'"
                                th:attr="data-id=${sp.id},data-tenSP=${sp.sanPham.tenSP}, data-donGia=${sp.sanPham.donGia}, data-soLuong=${sp.soLuong}"
                                onclick="selectProduct(this)">
                                <td th:text="${stat.index + 1}"></td>
                                <td th:text="${sp.sanPham.tenSP}"></td>
                                <td th:text="${sp.soLuong}"></td>
                                <td th:text="${sp.sanPham.donGia}"></td>
                                <td th:text="${sp.sanPham.thuongHieu.tenTH}"></td>
                                <td th:text="${sp.sanPham.chatLieu.tenCl}"></td>
                                <td th:text="${sp.sanPham.kichCo.tenKC}"></td>
                                <td th:text="${sp.mauSac.tenMS}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-5">
                        <div class="container">
                            <h5>Giỏ hàng</h5>
                            <div id="cartEmptyMessage" class="cart-empty" style="display: none;">
                                <p>Chưa có sản phẩm trong giỏ hàng</p>
                            </div>
                            <div >
                                <table class="posts-table" id="cartTable">
                                    <thead>
                                    <tr class="users-table-info" style="color: black; font-size: 15px;">
                                        <th>STT</th>
                                        <th>Tên Sản Phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Giá</th>
                                        <th >Tổng Tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody id="productTable"></tbody>
                                </table>
                            </div>
                            <!-- Tổng tiền hóa đơn -->
                            <div class="d-flex justify-content-between">
                                <h5>Tổng tiền:</h5>
                                <h5 id="modalTotal">0 VND</h5>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="customer-info mt-4 container">
                    <div class="row">
                        <div class="col-7">
                            <h5>Thông tin khách hàng</h5>
                            <div class="row">
                                <div class="col-7 position-relative">
                                    <input type="text" class="form-control me-2" placeholder="Tìm kiếm khách hàng" id="searchInput">
<!--                                    &lt;!&ndash; Danh sách khách hàng &ndash;&gt;-->
<!--                                    <div id="customerList" class="dropdown-menu show w-100"></div>-->
                                    <div>
                                        <label for="customerName">Tên khách hàng:</label>
                                        <span id="customerName">Khách hàng lẻ</span>
                                    </div>
                                    <div>
                                        <label for="customerSDT">Số điện thoai:</label>
                                        <span id="customerSDT"></span>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <button class="btn btn-warning">Thêm mới KH</button>
                                </div>
                            </div>

                        </div>
                        <div class="col-5">
                            <div>
                                <h5>Thông tin thanh toán</h5>
                            </div>
                        </div>
                    </div>
                </div></div>
        </main>
        <div th:insert="fragments/footer_admin :: footer"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script >
    let selectedInvoiceId = null;
    let carts = {};

    // Hàm khi click chọn hóa đơn
    function selectInvoice(invoiceId, maHD) {
        // Cập nhật mã hóa đơn chọn và in đậm
        document.querySelectorAll('.tab-item').forEach(item => {
            item.classList.remove('table-active'); // Xóa lớp "table-active" khỏi tất cả các hóa đơn
            item.classList.remove('btn-primary'); // Loại bỏ màu sắc trước đó
            item.classList.add('btn-outline-primary'); // Đặt lại màu sắc ban đầu
        });

        // Thêm lớp "table-active" và "btn-primary" cho hóa đơn được chọn
        const selectedInvoice = document.querySelector(`#invoice-${invoiceId}`);
        selectedInvoice.classList.add('table-active'); // Thêm lớp "table-active" cho hóa đơn được chọn
        selectedInvoice.classList.remove('btn-outline-primary'); // Loại bỏ màu nền outline
        selectedInvoice.classList.add('btn-primary'); // Thêm màu nền khi chọn

        document.getElementById('selected-invoice').textContent = maHD || 'Chưa có hóa đơn'; // Cập nhật mã hóa đơn hiển thị

        selectedInvoiceId = invoiceId; // Lưu lại ID hóa đơn đang chọn

        // Hiển thị giỏ hàng
        fetchInvoiceDetails(invoiceId); // Lấy chi tiết hóa đơn
    }

    // Hàm lấy chi tiết hóa đơn từ server
    function fetchInvoiceDetails(invoiceId) {
        fetch(`/admin/ban-hang/invoice-details?hoaDonId=${invoiceId}`)
            .then(response => {
                const contentType = response.headers.get("Content-Type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json();  // Nếu phản hồi là JSON, trả về dạng JSON
                } else {
                    return response.text();  // Nếu không phải JSON, trả về dưới dạng văn bản
                }
            })
            .then(data => {
                if (typeof data === 'string') {
                    // Nếu là văn bản (thông báo lỗi), hiển thị thông báo lỗi
                    console.error("Lỗi khi lấy chi tiết hóa đơn:", data);
                } else {
                    // Nếu là JSON (dữ liệu hợp lệ), xử lý dữ liệu bình thường
                    console.log(data); // In dữ liệu để kiểm tra
                    carts[invoiceId] = data; // Lưu dữ liệu giỏ hàng vào carts
                    displayInvoiceDetails(invoiceId); // Hiển thị chi tiết giỏ hàng
                }
            })
            .catch(error => {
                console.error("Lỗi khi lấy chi tiết hóa đơn:", error); // In lỗi chi tiết
            }); // Xử lý lỗi
    }
    // Hiển thị chi tiết giỏ hàng và tổng tiền
    function displayInvoiceDetails(invoiceId) {
        const productTable = document.getElementById('productTable');
        const totalElement = document.getElementById('modalTotal');
        productTable.innerHTML = ''; // Xóa giỏ hàng hiện tại
        let total = 0;

        // Kiểm tra xem giỏ hàng có tồn tại và có sản phẩm không
        if (carts[invoiceId] && Array.isArray(carts[invoiceId]) && carts[invoiceId].length > 0) {
            // Nhóm các sản phẩm có cùng id lại với nhau
            const groupedProducts = carts[invoiceId].reduce((acc, product) => {
                // Nếu sản phẩm đã có trong nhóm, cộng dồn số lượng
                if (acc[product.sanPhamChiTiet]) {
                    acc[product.sanPhamChiTiet].soLuong += product.soLuong;
                } else {
                    // Nếu chưa có, thêm mới vào nhóm
                    acc[product.sanPhamChiTiet] = { ...product };
                }
                return acc;
            }, {});

            // Hiển thị các sản phẩm đã nhóm và cộng dồn số lượng
            Object.values(groupedProducts).forEach((product, index) => {
                if (product.sanPhamChiTiet) {
                    const donGia = product.donGia && !isNaN(product.donGia) ? product.donGia : 0;
                    const soLuong = product.soLuong && !isNaN(product.soLuong) ? product.soLuong : 0;
                    const mauSac = product.tenMS || 'Chưa có';
                    const thuongHieu = product.tenTH || 'Chưa có';
                    const chatLieu = product.tenCL || 'Chưa có';
                    const kichCo = product.tenKC || 'Chưa có';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.tenSP}, ${mauSac}, ${thuongHieu}, ${chatLieu}, ${kichCo}</td>
                    <td>${product.soLuong}</td>
                    <td>${donGia.toLocaleString()} VND</td>
                    <td>${(soLuong * donGia).toLocaleString()} VND</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteProductFromInvoice(${product.sanPhamChiTiet})">Xóa tất cả</button>
                    </td>
                `;
                    productTable.appendChild(row); // Thêm sản phẩm vào bảng
                    total += soLuong * donGia; // Cộng tổng tiền
                } else {
                    console.error("Dữ liệu sản phẩm không đầy đủ:", product);
                }
            });

        } else {
            productTable.innerHTML = ''; // Đảm bảo bảng sản phẩm không có gì
        }

        // Cập nhật tổng tiền
        totalElement.textContent = `${total.toLocaleString()} VND`;
    }

    // Hàm xóa sản phẩm khỏi giỏ hàng
    function deleteProductFromInvoice(sanPhamChiTietId) {
        // Gửi yêu cầu xóa sản phẩm khỏi chi tiết hóa đơn trong DB
        fetch(`/admin/ban-hang/delete-product-from-invoice?sanPhamChiTietId=${sanPhamChiTietId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    return response.text(); // Nhận dữ liệu phản hồi từ server
                } else {
                    throw new Error('Không thể xóa sản phẩm khỏi hóa đơn!');
                }
            })
            .then(data => {
                // Cập nhật lại giỏ hàng
                displayInvoiceDetails(selectedInvoiceId);
                alert('Sản phẩm đã được xóa khỏi hóa đơn!');
            })
            .catch(error => {
                console.error('Lỗi khi xóa sản phẩm:', error);
                alert('Có lỗi xảy ra khi xóa sản phẩm!');
            });
    }




    function selectProduct(row) {
        if (!selectedInvoiceId) {
            alert('Vui lòng chọn hóa đơn trước!');
            return;
        }

        const tenSP = row.getAttribute('data-tenSP');
        const donGia = parseFloat(row.getAttribute('data-donGia'));
        const productId = row.getAttribute('data-id');  // Lấy ID sản phẩm chi tiết
        let availableQuantity = parseInt(row.getAttribute('data-soLuong'));  // Lấy số lượng có sẵn

        // Hiển thị prompt để nhập số lượng
        const quantity = prompt(`Nhập số lượng cho sản phẩm "${tenSP}": (Số lượng có sẵn: ${availableQuantity})`);
        if (quantity && !isNaN(quantity) && parseInt(quantity) > 0 && parseInt(quantity) <= availableQuantity) {
            const newQuantity = parseInt(quantity);

            // Lưu hoặc cập nhật sản phẩm vào giỏ hàng của hóa đơn
            const existingProduct = carts[selectedInvoiceId]?.find(product => product.id === productId);
            if (existingProduct) {
                // Cập nhật số lượng sản phẩm nếu đã tồn tại trong giỏ hàng
                existingProduct.soLuong += newQuantity;  // Cộng thêm số lượng vào giỏ
            } else {
                // Nếu sản phẩm chưa có trong giỏ, thêm vào giỏ hàng
                const product = {
                    tenSP: tenSP,
                    donGia: donGia,
                    soLuong: newQuantity,
                    id: productId
                };
                if (!carts[selectedInvoiceId]) {
                    carts[selectedInvoiceId] = [];
                }
                carts[selectedInvoiceId].push(product);
            }

            // Cập nhật lại số lượng sản phẩm trong bảng (trừ đi số lượng đã chọn)
            availableQuantity -= newQuantity; // Trừ số lượng đã chọn
            row.setAttribute('data-soLuong', availableQuantity);  // Cập nhật lại thuộc tính data-soLuong

            // Cập nhật lại số lượng hiển thị trong bảng
            updateProductQuantityInTable(productId, availableQuantity);

            // Tạo chi tiết hóa đơn ngay lập tức
            addProductToInvoice({
                tenSP: tenSP,
                donGia: donGia,
                soLuong: newQuantity,
                id: productId
            });
        } else {
            alert('Vui lòng nhập số lượng hợp lệ hoặc số lượng quá nhiều!');
        }
    }

    function updateProductQuantityInTable(productId, newQuantity) {
        const rows = document.querySelectorAll('#sanPhamTable tbody tr');

        // Tìm dòng sản phẩm tương ứng và cập nhật số lượng
        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            if (id === productId) {
                const quantityCell = row.querySelector('td:nth-child(3)'); // Giả sử cột số lượng là cột thứ 3
                if (quantityCell) {
                    quantityCell.textContent = newQuantity; // Cập nhật số lượng
                }
            }
        });
    }

    function addProductToInvoice(product) {
        const hoaDonId = selectedInvoiceId;
        const sanPhamChiTietId = product.id;
        const soLuong = product.soLuong;
        const donGia = product.donGia;

        fetch(`/admin/ban-hang/add-product-to-invoice?hoaDonId=${hoaDonId}&sanPhamChiTietId=${sanPhamChiTietId}&soLuong=${soLuong}&donGia=${donGia}`, {
            method: "POST",
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error("Không thể thêm sản phẩm vào hóa đơn!");
            })
            .then(data => {
                alert('Sản phẩm đã được thêm vào hóa đơn!');
                fetchInvoiceDetails(selectedInvoiceId); // Cập nhật lại chi tiết hóa đơn sau khi thêm sản phẩm
            })
            .catch(error => console.error("Lỗi:", error));
    }




    // Tạo hóa đơn mới
    function createInvoice() {
        const invoiceData = {
            maHD: "HD" + new Date().getTime(), // Tạo mã hóa đơn mới từ thời gian
            trangThaiHD: "Chưa thanh toán" // Đặt trạng thái hóa đơn mặc định
        };

        fetch('/admin/ban-hang/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invoiceData), // Gửi dữ liệu hóa đơn đến server
        })
            .then(response => {
                if (!response.ok) throw new Error('Không thể tạo hóa đơn!'); // Kiểm tra phản hồi từ server
                return response.json();
            })
            .then(data => {
                alert('Hóa đơn đã được tạo thành công!'); // Thông báo thành công
                location.reload(); // Reload lại trang
            })
            .catch(error => alert('Có lỗi xảy ra khi tạo hóa đơn!')); // Xử lý lỗi
    }
    // Hàm xóa chi tiết hóa đơn
    function deleteInvoiceDetails(invoiceId) {
        fetch(`/admin/ban-hang/delete-details?hoaDonId=${invoiceId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Không thể xóa chi tiết hóa đơn!');
                }
            })
            .then(data => {
                // Sau khi xóa chi tiết hóa đơn thành công, xóa hóa đơn
                deleteInvoiceRecord(invoiceId);
            })
            .catch(error => {
                alert('Có lỗi xảy ra khi xóa chi tiết hóa đơn!');
            });
    }

    // Hàm xóa hóa đơn
    function deleteInvoiceRecord(invoiceId) {
        fetch(`/admin/ban-hang/delete?hoaDonId=${invoiceId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (response.ok) {
                    alert('Hóa đơn đã được xóa thành công!');
                    location.reload(); // Reload lại trang để cập nhật danh sách hóa đơn
                } else {
                    throw new Error('Không thể xóa hóa đơn!');
                }
            })
            .catch(error => {
                alert('Có lỗi xảy ra khi xóa hóa đơn!');
            });
    }

    // Hàm xóa hóa đơn khi nhấn nút xóa
    function deleteInvoice(invoiceId) {
        // Xóa chi tiết hóa đơn trước
        deleteInvoiceDetails(invoiceId);
    }

    // Hàm cập nhật số lượng sản phẩm khi thay đổi
    document.addEventListener('input', function(event) {
        if (event.target && event.target.classList.contains('quantity-input')) {
            const newQuantity = parseInt(event.target.value);
            const productId = event.target.getAttribute('data-id');

            // Cập nhật số lượng trong giỏ hàng
            const product = carts[selectedInvoiceId].find(p => p.id === productId);
            if (product) {
                product.soLuong = newQuantity;
            }

            // Cập nhật lại tổng tiền
            displayInvoiceDetails(selectedInvoiceId);
        }
    });

    // Thêm sự kiện lắng nghe cho các hóa đơn
    document.addEventListener('DOMContentLoaded', function () {
        const invoiceElements = document.querySelectorAll('.tab-item');

        // Lắng nghe sự kiện click cho các phần tử có id bắt đầu bằng "invoice-"
        invoiceElements.forEach(element => {
            element.addEventListener('click', function() {
                const invoiceId = this.id.split('-')[1]; // Lấy ID hóa đơn từ id của phần tử
                const maHD = this.textContent.trim(); // Lấy mã hóa đơn từ nội dung phần tử

                selectInvoice(invoiceId, maHD); // Chọn hóa đơn và hiển thị giỏ hàng
            });
        });
    });

    const searchInput = document.getElementById('searchInput');
    const customerList = document.getElementById('customerList');

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim();
        if (query.length === 0) {
            customerList.innerHTML = '';
            return;
        }

        fetch(`/admin/ban-hang/khachhang/search?sdt=${query}`)
            .then(response => response.json())
            .then(data => {
                customerList.innerHTML = ''; // Xóa danh sách cũ
                data.forEach(customer => {
                    const customerItem = document.createElement('div');
                    customerItem.className = 'dropdown-item';
                    customerItem.innerHTML = `
                        <strong>${customer.tenKH}</strong> <br>
                        <small>${customer.sdt}</small>
                    `;
                    customerItem.addEventListener('click', () => {
                        document.getElementById('customerName').innerText = customer.tenKH;
                        customerList.innerHTML = '';
                    });
                    customerList.appendChild(customerItem);
                });
            });
    });


</script>
</body>
</html>
