<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto_Kid | Quản Lý Sản Phẩm</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="./img/svg/logo.svg" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom styles -->
    <link rel="stylesheet" href="./css/style.min.css" type="text/css">
    <style>
        .table-wrapper {
            max-height: 400px; /* Chiều cao cố định cho vùng cuộn */
            overflow-y: auto;  /* Kích hoạt thanh cuộn dọc */
        }

        .table {
            width: 100%; /* Đảm bảo bảng chiếm hết chiều rộng */
            table-layout: fixed; /* Giới hạn chiều rộng của các cột */
        }

        .table th, .table td {
            white-space: nowrap; /* Ngăn ngừa văn bản bị cắt ngắn trong bảng */
            overflow: hidden;
            text-overflow: ellipsis; /* Hiển thị dấu ba chấm khi văn bản quá dài */
        }

        .invoice-container {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .table {
            width: 100%;
            margin-bottom: 15px;
        }
        .table-active {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }

    </style>
</head>
<body>
<!-- ! Body -->
<a class="skip-link sr-only" href="#skip-target">Bỏ qua nội dung</a>
<div class="page-flex">
    <div th:insert="fragments/sidebar_admin :: sidebar"></div>
    <div class="main-wrapper">
        <div th:insert="fragments/header_admin :: header"></div>
        <main class="main users chart-page" id="skip-target">
            <div class="" style="padding: 7px">
                <h2 class="main-title">Bán Hàng</h2>
                <div class="filter-section mb-4">
                    <form class="row g-3" id="productFilterForm">
                        <div class="col-1">
                            <input type="text" class="form-control" placeholder="Tên sản phẩm" name="productName">
                        </div>
                        <div class="col-1">
                            <select class="form-control" id="loaiSanPham" name="loaiSanPham" required>
                                <option value="" disabled selected>Loại sản phẩm</option>
                                <option th:each="loaiSanPham : ${dsLoaiSanPham}" th:value="${loaiSanPham.idLoaiSP}" th:text="${loaiSanPham.tenLoai}"></option>
                            </select>
                        </div>
                        <div class="col-1">
                            <select class="form-control" id="thuongHieu" name="thuongHieu" required>
                                <option value="" disabled selected>Thương hiệu</option>
                                <option th:each="thuongHieu : ${dsThuongHieu}" th:value="${thuongHieu.id}" th:text="${thuongHieu.tenTH}"></option>
                            </select>
                        </div>
                        <div class="col-1">
                            <select class="form-control" id="kichCo" name="kichCo" required>
                                <option value="" disabled selected>Kích cỡ</option>
                                <option th:each="kichCo : ${dsKichCo}" th:value="${kichCo.id}" th:text="${kichCo.tenKC}"></option>
                            </select>
                        </div>
                        <div class="col-1">
                            <select class="form-control" id="chatLieu" name="chatLieu" required>
                                <option value="" disabled selected>Chất liệu</option>
                                <option th:each="chatLieu : ${dsChatLieu}" th:value="${chatLieu.id}" th:text="${chatLieu.tenCl}"></option>
                            </select>
                        </div>
                        <div class="col-1">
                            <select class="form-control" id="mauSac" name="mauSac" required>
                                <option value="" disabled selected>Màu sắc</option>
                                <option th:each="mauSac : ${dsMauSac}" th:value="${mauSac.id}" th:text="${mauSac.tenMS}"></option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
                        </div>
                    </form>
                </div>
                <hr>
                <div class="row">
                    <div class="col-8">
                        <div>
                            <button type="button" class="btn btn-primary" onclick="createInvoice()">Tạo Hóa Đơn</button>
                            <table class="table table-bordered">
                                <thead>
                                <tr class="users-table-info ">
                                    <th>Mã hóa đơn</th>
                                    <th>Ngày tạo</th>
                                    <th>Trạng thái</th>
                                </tr>
                                </thead>
                                <tbody class="invoice-table">
                                <tr th:each="hd : ${lhd}" th:data-id="${hd.id}">
                                    <td th:text="${hd.maHD}"></td>
                                    <td th:text="${hd.ngayTao}"></td>
                                    <td th:text="${hd.trangThaiHD}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <div class="table-wrapper">
                                <table class="table table-bordered">
                                    <thead>
                                    <tr class="users-table-info ">
                                        <th>Mã sản phẩm</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Giá bán</th>
                                        <th>Thương hiệu</th>
                                        <th>Chất liệu</th>
                                        <th>Kích cỡ</th>
                                        <th>Màu sắc</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="sp : ${spcts}"
                                        th:attr="data-id=${sp.id},data-tenSP=${sp.sanPham.tenSP}, data-donGia=${sp.sanPham.donGia}, data-soLuong=${sp.soLuong}"
                                        onclick="selectProduct(this)">
                                        <td th:text="${sp.maSPCT}"></td>
                                        <td th:text="${sp.sanPham.tenSP}"></td>
                                        <td th:text="${sp.soLuong}"></td>
                                        <td th:text="${sp.sanPham.donGia}"></td>
                                        <td th:text="${sp.sanPham.thuongHieu.tenTH}"></td>
                                        <td th:text="${sp.sanPham.chatLieu.tenCl}"></td>
                                        <td th:text="${sp.sanPham.kichCo.tenKC}"></td>
                                        <td th:text="${sp.mauSac.tenMS}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <!-- Nội dung hóa đơn -->
                        <div class="tab-content" id="invoiceTabContent">
                            <div class="tab-pane fade show active" id="invoice1" role="tabpanel" aria-labelledby="tab1">
                                <h3>Giỏ hàng</h3>
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Tên sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody class="invoice-items">
                                    <!-- Các sản phẩm sẽ được thêm vào đây -->
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end">Tổng tiền:</td>
                                        <td class="total">0 VND</td>
                                    </tr>
                                    </tfoot>
                                </table>
                                <button class="btn btn-success mt-3 w-100" data-bs-toggle="modal" data-bs-target="#paymentModal">Thanh toán</button>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
        <div th:insert="fragments/footer_admin :: footer"></div>
    </div>

    <!-- Modal Thanh Toán -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 class="text-center">Thông Tin Hóa Đơn</h4>
                    <!-- Thông tin cơ bản của hóa đơn -->
                    <div class="mb-3">
                        <strong>Mã hóa đơn:</strong> <span id="invoiceCode">#123456</span><br>
                        <strong>Tên khách hàng:</strong> <span id="customerName">Nguyễn Văn A</span><br>
                        <strong>Tên nhân viên:</strong> <span id="staffName">Trần Thị B</span><br>
                        <strong>Ngày tạo:</strong> <span id="creationDate">21/11/2024</span>
                    </div>

                    <!-- Bảng danh sách sản phẩm -->
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th scope="col">STT</th>
                            <th scope="col">Tên Sản Phẩm</th>
                            <th scope="col">Giá Bán</th>
                            <th scope="col">Tổng Tiền</th>
                        </tr>
                        </thead>
                        <tbody id="productTable">
                        <!-- Các dòng sản phẩm sẽ được thêm động ở đây -->
                        </tbody>
                    </table>

                    <!-- Tổng tiền hóa đơn -->
                    <div class="d-flex justify-content-between">
                        <h5>Tổng tiền:</h5>
                        <h5 id="modalTotal">0 VND</h5>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary">Thanh Toán</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>


</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    let selectedInvoiceId = null; // Lưu mã hóa đơn đang chọn
    let carts = {}; // Lưu trữ giỏ hàng theo từng mã hóa đơn
    window.addEventListener('load', function () {
        if (selectedInvoiceId) {
            fetchInvoiceDetails(selectedInvoiceId);
        }
    });
    function fetchInvoiceDetails(invoiceId) {
        fetch(`/admin/ban-hang/invoice-details?hoaDonId=${invoiceId}`)
            .then(response => {
                console.log("Phản hồi từ server:", response);  // Kiểm tra phản hồi
                return response.text();  // Lấy dưới dạng văn bản thay vì JSON
            })
            .then(data => {
                console.log("Nội dung phản hồi từ server:", data);  // Kiểm tra nội dung phản hồi
                try {
                    const parsedData = JSON.parse(data);  // Cố gắng chuyển đổi sang JSON
                    console.log("Dữ liệu chi tiết hóa đơn:", parsedData);

                    carts[invoiceId] = parsedData.map(product => ({
                        tenSP: product.tenSP,
                        donGia: product.donGia,
                        soLuong: product.soLuong,
                        id: product.sanPhamChiTiet?.id
                    }));

                    displayCart();
                } catch (e) {
                    console.error("Lỗi khi phân tích cú pháp JSON:", e);
                    console.error("Nội dung không hợp lệ:", data);
                }
            })
            .catch(error => {
                console.error("Lỗi khi lấy chi tiết hóa đơn:", error);
            });
    }


    // Khi click vào dòng hóa đơn
    document.querySelectorAll('tbody.invoice-table tr').forEach(row => {
        row.addEventListener('click', function () {
            // Xóa highlight cho các dòng khác
            document.querySelectorAll('tbody.invoice-table tr').forEach(r => r.classList.remove('table-active'));
            // Highlight dòng được chọn
            this.classList.add('table-active');
            // Lưu mã hóa đơn
            selectedInvoiceId = this.getAttribute('data-id');
            // Lấy và hiển thị giỏ hàng của hóa đơn đã chọn
            fetchInvoiceDetails(selectedInvoiceId);
        });
    });

    // Hiển thị giỏ hàng của hóa đơn đang chọn
    function displayCart() {
        const cartBody = document.querySelector('.invoice-items');
        const totalElement = document.querySelector('.total');
        cartBody.innerHTML = ''; // Xóa giỏ hàng hiện tại
        let total = 0;

        // Kiểm tra xem có giỏ hàng cho hóa đơn đã chọn không
        if (carts[selectedInvoiceId]) {
            carts[selectedInvoiceId].forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${product.tenSP}</td>
            <td>${product.soLuong}</td>
            <td>${product.donGia.toLocaleString()} VND</td>
            <td>${(product.soLuong * product.donGia).toLocaleString()} VND</td>
        `;
                cartBody.appendChild(row);
                total += product.soLuong * product.donGia;
            });
        }

        // Cập nhật tổng tiền
        totalElement.innerText = `${total.toLocaleString()} VND`;
    }

    // Khi chọn sản phẩm từ bảng sản phẩm
    function selectProduct(row) {
        if (!selectedInvoiceId) {
            alert('Vui lòng chọn hóa đơn trước!');
            return;
        }

        const tenSP = row.getAttribute('data-tenSP');
        const donGia = parseFloat(row.getAttribute('data-donGia'));

        // Hiển thị prompt để nhập số lượng
        const quantity = prompt(`Nhập số lượng cho sản phẩm "${tenSP}":`);
        if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
            const product = {
                tenSP: tenSP,
                donGia: donGia,
                soLuong: parseInt(quantity),
                id: row.getAttribute('data-id')  // Lấy ID sản phẩm chi tiết
            };

            // Lưu sản phẩm vào giỏ hàng của hóa đơn
            if (!carts[selectedInvoiceId]) {
                carts[selectedInvoiceId] = [];
            }
            carts[selectedInvoiceId].push(product);

            // Hiển thị giỏ hàng sau khi thêm sản phẩm
            displayCart();

            // Tạo chi tiết hóa đơn ngay lập tức
            addProductToInvoice(product);
        } else {
            alert('Vui lòng nhập số lượng hợp lệ!');
        }
    }

    // Tạo chi tiết hóa đơn và thêm sản phẩm vào hóa đơn
    function addProductToInvoice(product) {
        const hoaDonId = selectedInvoiceId;
        const sanPhamChiTietId = product.id;
        const soLuong = product.soLuong;
        const donGia = product.donGia;

        fetch(`/admin/ban-hang/add-product-to-invoice?hoaDonId=${hoaDonId}&sanPhamChiTietId=${sanPhamChiTietId}&soLuong=${soLuong}&donGia=${donGia}`, {
            method: "POST",
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error("Không thể thêm sản phẩm vào hóa đơn!");
            })
            .then(data => alert(data))
            .catch(error => console.error("Lỗi:", error));
    }
    // Tạo hóa đơn mới
    function createInvoice() {
        const invoiceData = {
            maHD: "HD" + new Date().getTime(),
            trangThaiHD: "Chưa thanh toán",
        };

        fetch('/admin/ban-hang/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(invoiceData),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tạo hóa đơn!');
                }
                return response.json();
            })
            .then(data => {
                alert('Hóa đơn đã được tạo thành công!');
                location.reload(); // Reload lại trang để cập nhật danh sách hóa đơn
            })
            .catch(error => {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra khi tạo hóa đơn!');
            });
    }


</script>
</body>
</html>
